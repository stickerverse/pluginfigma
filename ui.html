<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Figma Direct Paste</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      color: #333;
      background: #fff;
      font-size: 14px;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 100%;
      width: 100%;
    }
    
    h2 {
      margin: 0 0 16px 0;
      font-weight: 600;
      font-size: 16px;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
      flex-grow: 1;
    }
    
    .input-label {
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 12px;
      color: #555;
    }
    
    textarea {
      flex-grow: 1;
      min-height: 250px;
      padding: 12px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      resize: none;
    }
    
    textarea:focus {
      border-color: #18a0fb;
      outline: none;
    }
    
    .button-group {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
      gap: 12px;
    }
    
    button {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .primary-button {
      background: #18a0fb;
      color: white;
      border: none;
    }
    
    .primary-button:hover {
      background: #0d8edf;
    }
    
    .secondary-button {
      background: white;
      color: #333;
      border: 1px solid #e5e5e5;
    }
    
    .secondary-button:hover {
      background: #f5f5f5;
    }
    
    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 4px;
      font-size: 13px;
      display: none;
    }
    
    .error {
      background: #fff3f3;
      color: #d32f2f;
      border: 1px solid #ffcaca;
    }
    
    .success {
      background: #ecf8f0;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 1px solid #e5e5e5;
    }
    
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 500;
      color: #777;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      color: #18a0fb;
      border-bottom: 2px solid #18a0fb;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    
    code {
      background: #f5f5f5;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
    }
    
    /* Progress bar styles */
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background-color: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .progress-bar {
      height: 100%;
      background-color: #18a0fb;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .progress-label {
      font-size: 12px;
      font-weight: 500;
      margin-top: 16px;
      color: #333;
    }
    
    .progress-text {
      font-size: 12px;
      text-align: right;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Figma Direct Paste</h2>
    
    <div class="tabs">
      <div class="tab active" data-tab="paste">Paste JSON</div>
      <div class="tab" data-tab="help">How It Works</div>
    </div>
    
    <div class="tab-content active" data-tab-content="paste">
      <div class="input-group">
        <label class="input-label">Paste Figma-compatible JSON here or use the Chrome extension:</label>
        <textarea id="jsonInput" placeholder='Paste your Figma JSON data here. For example:
{
  "figma": {
    "version": "1.0.0",
    "nodes": {
      "id": {
        "type": "FRAME",
        "name": "Component",
        "fills": [{
          "type": "SOLID",
          "color": { "r": 0, "g": 0.831, "b": 1 }
        }]
      }
    }
  }
}'></textarea>
      </div>
      
      <div id="progressContainer" style="display: none;">
        <div class="progress-label">Receiving component data...</div>
        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="progress-text">0%</div>
      </div>
      
      <div id="statusMessage" class="status"></div>
      
      <div class="button-group">
        <button id="cancelButton" class="secondary-button">Cancel</button>
        <button id="pasteButton" class="primary-button">Apply to Figma</button>
      </div>
    </div>
    
    <div class="tab-content" data-tab-content="help">
      <div style="padding: 12px; overflow-y: auto; flex-grow: 1;">
        <h3>How Direct Figma Pasting Works</h3>
        <h4>1. Figma's Clipboard Format</h4>
        <p>
          When you copy elements in Figma, they're stored in the clipboard as a special JSON structure that includes:
        </p>
        <ul>
          <li>Node types (frames, rectangles, text, etc.)</li>
          <li>Properties (fills, strokes, effects)</li>
          <li>Layout information</li>
          <li>Style references</li>
        </ul>
        
        <h4>2. The Technical Process</h4>
        <p>
          This plugin accepts Figma-compatible JSON data and creates corresponding Figma elements.
        </p>
        <p>
          The JSON structure should follow Figma's format:
        </p>
        <pre><code>{
  "figma": {
    "version": "1.0.0",
    "nodes": {
      "id": {
        "type": "FRAME",
        "name": "Component",
        "fills": [{
          "type": "SOLID",
          "color": { "r": 0, "g": 0.831, "b": 1 }
        }],
        "children": ["childId1", "childId2"]
      }
    }
  }
}</code></pre>
      
        <h4>3. Supported Node Types</h4>
        <p>The plugin currently supports these Figma node types:</p>
        <ul>
          <li>FRAME</li>
          <li>RECTANGLE</li>
          <li>TEXT</li>
          <li>COMPONENT</li>
          <li>GROUP</li>
        </ul>
      </div>
      
      <div class="button-group">
        <button id="backButton" class="secondary-button">Back to Paste</button>
      </div>
    </div>
  </div>

  <script>
    // Get references to UI elements
    const jsonInput = document.getElementById('jsonInput');
    const pasteButton = document.getElementById('pasteButton');
    const cancelButton = document.getElementById('cancelButton');
    const backButton = document.getElementById('backButton');
    const statusMessage = document.getElementById('statusMessage');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // Tab switching functionality
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        
        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active content
        tabContents.forEach(content => {
          if (content.getAttribute('data-tab-content') === tabName) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });
      });
    });
    
    // Back button handler
    backButton.addEventListener('click', () => {
      tabs[0].click();
    });
    
    // Apply button handler
    pasteButton.addEventListener('click', () => {
      try {
        // Get the JSON input
        const jsonString = jsonInput.value.trim();
        if (!jsonString) {
          showStatus('Please paste Figma-compatible JSON data.', 'error');
          return;
        }
        
        // Parse the JSON to validate it
        const figmaData = JSON.parse(jsonString);
        
        // Check if it has the expected structure
        if (!figmaData.figma || !figmaData.figma.nodes) {
          showStatus('Invalid Figma data format. Make sure it contains the "figma" object with "nodes".', 'error');
          return;
        }
        
        // Send the data to the plugin code
        parent.postMessage({ 
          pluginMessage: { 
            type: 'paste-data', 
            figmaData 
          }
        }, '*');
        
        showStatus('Processing...', 'success');
      } catch (error) {
        showStatus(`Error: ${error.message}`, 'error');
      }
    });
    
    // Cancel button handler
    cancelButton.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });
    
    // Function to show status messages
    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.style.display = 'block';
      statusMessage.className = `status ${type}`;
    }
    
    // Functions for managing the progress bar
    function showProgressBar() {
      document.getElementById('progressContainer').style.display = 'block';
    }
    
    function hideProgressBar() {
      document.getElementById('progressContainer').style.display = 'none';
    }
    
    function updateProgressBar(progress) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `${progress}%`;
    }
    
    function updateProgressLabel(text) {
      const progressLabel = document.querySelector('.progress-label');
      progressLabel.textContent = text;
    }
    
    /**
     * Debug logging utility with timestamps and context
     */
    function debugLog(context, ...args) {
      const timestamp = new Date().toISOString().substring(11, 23);
      console.log(`[${timestamp}][${context}]`, ...args);
    }
    
    // Handle communication with Chrome extension
    window.addEventListener('message', (event) => {
      // Check if this is a message from the Chrome extension
      if (event.data && event.data.source === 'sticker-chrome-extension') {
        debugLog('figma-ui', 'Received message from Chrome extension:', event.data);
        
        // Forward the message to the Figma plugin
        parent.postMessage({
          pluginMessage: {
            type: event.data.type || 'component-data',
            action: event.data.action,
            source: 'chrome-extension',
            basicData: event.data.basicData,
            figmaData: event.data.figmaData,
            chunk: event.data.chunk,
            metadata: event.data.metadata,
            componentId: event.data.componentId,
            chunkIndex: event.data.chunkIndex,
            totalChunks: event.data.totalChunks
          }
        }, '*');
        
        // Respond to Chrome extension that we received the message
        window.postMessage({
          source: 'sticker-figma-plugin',
          type: 'extension-message-received',
          timestamp: Date.now()
        }, '*');
      }
    });
    
    // Regularly announce plugin presence for detection
    setInterval(() => {
      window.postMessage({
        source: 'sticker-figma-plugin',
        type: 'plugin-ui-ready',
        timestamp: Date.now()
      }, '*');
    }, 1000);
    
    // Listen for messages from the plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      debugLog('figma-ui', 'Received message from plugin:', msg.type, msg);
      
      switch (msg.type) {
        // Basic creation success/error messages
        case 'creation-complete':
          hideProgressBar();
          showStatus('Success! Elements have been created in Figma.', 'success');
          break;
          
        case 'creation-error':
          hideProgressBar();
          showStatus(`Error: ${msg.message}`, 'error');
          break;
          
        // Progressive capture messages
        case 'basic-structure-received':
          showStatus('Basic component structure received, processing styles...', 'info');
          break;
          
        case 'preview-created':
          showStatus('Component preview created! Receiving full component data...', 'success');
          break;
          
        case 'preview-error':
          showStatus(`Error creating preview: ${msg.message}`, 'error');
          break;
          
        // Chunked data messages
        case 'chunked-start-received':
          showProgressBar();
          updateProgressLabel('Preparing to receive chunked component data...');
          updateProgressBar(0);
          break;
          
        case 'chunked-progress':
          showProgressBar();
          updateProgressLabel(`Receiving component data (${msg.componentId})...`);
          updateProgressBar(msg.progress);
          break;
          
        case 'chunked-complete':
          hideProgressBar();
          showStatus('Successfully processed all component chunks!', 'success');
          break;
          
        case 'chunked-error':
          hideProgressBar();
          showStatus(`Error processing chunks: ${msg.message}`, 'error');
          break;
      }
    };
  </script>
</body>
</html>
